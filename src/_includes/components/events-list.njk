{#
  Reusable events list component
  Parameters:
  - events: events data object
  - limit: max number of events to show (optional, shows all if not set)
  - showRecurring: whether to show recurring events section (default: true)
  - showUpcoming: whether to show upcoming one-time events section (default: true)
#}

{% if events.error %}
  <div class="data-unavailable">
    <div class="icon">
      <i class="fas fa-calendar" aria-hidden="true"></i>
    </div>
    <h2>Events Unavailable</h2>
    <p>{{ events.error }}</p>
    <p class="mt-3">Please check back later or contact us for upcoming events.</p>
  </div>
{% elif events.items.length > 0 %}
  {# Filter active events and separate recurring vs. one-time #}
  {% set recurringEvents = [] %}
  {% set oneTimeEvents = [] %}
  
  {% for event in events.items %}
    {# Check if event is active - accept any truthy value #}
    {% if event.active %}
      {% if not event.date or event.date | trim == '' %}
        {# No date = recurring event #}
        {% set recurringEvents = (recurringEvents.push(event), recurringEvents) %}
      {% else %}
        {# Has date = one-time event #}
        {% set oneTimeEvents = (oneTimeEvents.push(event), oneTimeEvents) %}
      {% endif %}
    {% endif %}
  {% endfor %}
  
  {# Sort recurring by sort column if present, otherwise preserve table order #}
  {% set sortedRecurring = recurringEvents %}
  {% if recurringEvents.length > 0 and recurringEvents[0].sort %}
    {% set sortedRecurring = recurringEvents | sort(false, false, 'sort') %}
  {% endif %}
  
  {# Sort one-time by date, or by sort if present #}
  {% set sortedOneTime = oneTimeEvents | sort(false, false, 'date') %}
  {% for event in oneTimeEvents %}
    {% if event.sort %}
      {% set sortedOneTime = oneTimeEvents | sort(false, false, 'sort') %}
    {% endif %}
  {% endfor %}
  
  {# Combine arrays if on homepage (limit provided) #}
  {% if limit %}
    {# Merge recurring and one-time events based on showRecurring parameter #}
    {% set allEvents = [] %}
    {% if showRecurring != false %}
      {% for event in sortedRecurring %}
        {% set allEvents = (allEvents.push(event), allEvents) %}
      {% endfor %}
    {% endif %}
    {% for event in sortedOneTime %}
      {% set allEvents = (allEvents.push(event), allEvents) %}
    {% endfor %}
    
    <div class="row">
      {% set count = 0 %}
      {% for event in allEvents %}
        {% if count < limit %}
          <div class="col-md-4 mb-4">
            <div class="card event-card h-100">
              {% if event.image_url %}
                <img src="{{ event.image_url | eventImage }}" 
                     class="card-img-top event-poster" 
                     alt="{% if event.image_alt and event.image_alt | trim %}{{ event.image_alt }}{% endif %}"
                     loading="lazy">
              {% endif %}
              <div class="card-body d-flex flex-column">
                <h3 class="card-title h5">{{ event.title }}</h3>
                <div class="text-muted mb-3">
                  {% if event.date %}
                    <p class="mb-1">
                      <i class="far fa-calendar" aria-hidden="true"></i>
                      {{ event.date | formatDate }}
                    </p>
                  {% endif %}
                  {% if event.time_start %}
                    <p class="mb-1">
                      <i class="far fa-clock" aria-hidden="true"></i> {{ event.time_start }}{% if event.time_end and event.time_end | trim %} - {{ event.time_end }}{% endif %}
                    </p>
                  {% endif %}
                  {% if event.price %}
                    <p class="mb-1">
                      <i class="fas fa-ticket-alt" aria-hidden="true"></i> {{ event.price | formatPrice }}
                    </p>
                  {% endif %}
                </div>
                {% if event.description %}
                  <p class="card-text">{{ event.description | truncate(120) }}</p>
                {% endif %}
                {% if event.ticket_link or event.instagram_link %}
                  <div class="mt-auto">
                    {% if event.ticket_link %}
                      <a href="{{ event.ticket_link }}" class="hero-btn hero-btn-sm me-2 mb-2">
                        <i class="fas fa-ticket-alt" aria-hidden="true"></i> Tickets
                      </a>
                    {% endif %}
                    {% if event.instagram_link %}
                      <a href="{{ event.instagram_link }}" class="hero-btn hero-btn-sm mb-2">
                        <i class="fab fa-instagram" aria-hidden="true"></i> Instagram
                      </a>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% set count = count + 1 %}
        {% endif %}
      {% endfor %}
    </div>
  {% else %}
    {# Full page display with sections #}
    {# Show recurring events section #}
    {% if showRecurring and sortedRecurring.length > 0 %}
      <section class="mb-5">
        <h2 class="h3 mb-3">Regular Events</h2>
        <div class="row">
          {% for event in sortedRecurring %}
            <div class="col-md-6 col-lg-4 mb-4">
              <div class="card event-card h-100">
                {% if event.image_url %}
                  <img src="{{ event.image_url | eventImage }}" 
                       class="card-img-top event-poster" 
                       alt="{% if event.image_alt and event.image_alt | trim %}{{ event.image_alt }}{% endif %}"
                       loading="lazy">
                {% endif %}
                <div class="card-body d-flex flex-column">
                  <h3 class="card-title h5">{{ event.title }}</h3>
                  {% if event.recurring_pattern %}
                    <p class="recurring-pattern mb-2">
                      <i class="fas fa-calendar-week" aria-hidden="true"></i> {{ event.recurring_pattern }}
                    </p>
                  {% endif %}
                  <div class="text-muted mb-3">
                    {% if event.time_start %}
                      <p class="mb-1">
                        <i class="far fa-clock" aria-hidden="true"></i> {{ event.time_start }}{% if event.time_end and event.time_end | trim %} - {{ event.time_end }}{% endif %}
                      </p>
                    {% endif %}
                    {% if event.price %}
                      <p class="mb-1">
                        <i class="fas fa-ticket-alt" aria-hidden="true"></i> {{ event.price | formatPrice }}
                      </p>
                    {% endif %}
                  </div>
                  {% if event.description %}
                    <p class="card-text">{{ event.description }}</p>
                  {% endif %}
                  {% if event.ticket_link or event.instagram_link %}
                    <div class="mt-auto">
                      {% if event.ticket_link %}
                        <a href="{{ event.ticket_link }}" class="hero-btn hero-btn-sm me-2 mb-2">
                          <i class="fas fa-ticket-alt" aria-hidden="true"></i> Tickets
                        </a>
                      {% endif %}
                      {% if event.instagram_link %}
                        <a href="{{ event.instagram_link }}" class="hero-btn hero-btn-sm mb-2">
                          <i class="fab fa-instagram" aria-hidden="true"></i> Instagram
                        </a>
                      {% endif %}
                    </div>
                  {% elif event.link %}
                    <div class="mt-auto">
                      <a href="{{ event.link }}" class="btn btn-outline-primary">
                        Learn More <i class="fas fa-external-link-alt" aria-hidden="true"></i>
                      </a>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </section>
    {% endif %}
    
    {# Show upcoming one-time events section #}
    {% if showUpcoming and sortedOneTime.length > 0 %}
      <section class="mb-5">
        <h2 class="h3 mb-3">Upcoming Events</h2>
        <div class="row">
          {% for event in sortedOneTime %}
            <div class="col-md-6 col-lg-4 mb-4">
              <div class="card event-card h-100">
                {% if event.image_url %}
                  <img src="{{ event.image_url | eventImage }}" 
                       class="card-img-top event-poster" 
                       alt="{% if event.image_alt and event.image_alt | trim %}{{ event.image_alt }}{% endif %}"
                       loading="lazy">
                {% endif %}
                <div class="card-body d-flex flex-column">
                  <h3 class="card-title h5">{{ event.title }}</h3>
                  <div class="text-muted mb-3">
                    <p class="mb-1">
                      <i class="far fa-calendar" aria-hidden="true"></i>
                      {{ event.date | formatDate }}
                    </p>
                    {% if event.time_start %}
                      <p class="mb-1">
                        <i class="far fa-clock" aria-hidden="true"></i> {{ event.time_start }}{% if event.time_end and event.time_end | trim %} - {{ event.time_end }}{% endif %}
                      </p>
                    {% endif %}
                    {% if event.price %}
                      <p class="mb-1">
                        <i class="fas fa-ticket-alt" aria-hidden="true"></i> {{ event.price | formatPrice }}
                      </p>
                    {% endif %}
                  </div>
                  {% if event.description %}
                    <p class="card-text">{{ event.description }}</p>
                  {% endif %}
                  {% if event.ticket_link or event.instagram_link %}
                    <div class="mt-auto">
                      {% if event.ticket_link %}
                        <a href="{{ event.ticket_link }}" class="hero-btn hero-btn-sm me-2 mb-2">
                          <i class="fas fa-ticket-alt" aria-hidden="true"></i> Tickets
                        </a>
                      {% endif %}
                      {% if event.instagram_link %}
                        <a href="{{ event.instagram_link }}" class="hero-btn hero-btn-sm mb-2">
                          <i class="fab fa-instagram" aria-hidden="true"></i> Instagram
                        </a>
                      {% endif %}
                    </div>
                  {% elif event.link %}
                    <div class="mt-auto">
                      <a href="{{ event.link }}" class="btn btn-outline-primary">
                        Learn More <i class="fas fa-external-link-alt" aria-hidden="true"></i>
                      </a>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </section>
    {% endif %}
    
    {# Show message if no active events #}
    {% if sortedRecurring.length == 0 and sortedOneTime.length == 0 %}
      <div class="alert alert-info" role="alert">
        <h2 class="h5">No upcoming events</h2>
        <p class="mb-0">We don't have any events scheduled at the moment. Check back soon!</p>
      </div>
    {% endif %}
  {% endif %}
{% else %}
  <div class="alert alert-info" role="alert">
    <h2 class="h5">No upcoming events</h2>
    <p class="mb-0">We don't have any events scheduled at the moment. Check back soon!</p>
  </div>
{% endif %}
